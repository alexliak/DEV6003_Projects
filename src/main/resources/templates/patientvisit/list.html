<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layout}">
    <head>
        <title>Patient Exams</title>
        <style>
            .diagnosis-badge {
                font-size: 0.875rem;
                padding: 0.25rem 0.5rem;
            }
            .patient-info {
                font-weight: 500;
            }
            .doctor-info {
                color: #0066cc;
                font-weight: 500;
            }
            .no-access {
                color: #dc3545;
                font-style: italic;
            }
        </style>
    </head>
    <body>
        <div layout:fragment="content">
            <div class="d-flex flex-wrap mb-4">
                <h1 class="flex-grow-1">Patient exam</h1>
                <div th:if="${isDoctor}">
                    <a th:href="@{/patientvisits/add}" class="btn btn-primary ms-2">Create new patient exam</a>
                </div>
            </div>
            <div th:if="${patientvisits.empty}">No patient exams found</div>
            <div th:if="${!patientvisits.empty}" class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead>
                        <tr>
                            <th scope="col">Exam id</th>
                            <th scope="col">Examination date</th>
                            <th scope="col">Patient</th>
                            <th scope="col">Doctor</th>
                            <th scope="col">Diagnosis</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="patientvisit : ${patientvisits}">
                            <td>[[${patientvisit.visitid}]]</td>
                            <td>
                                <span th:if="${patientvisit.formattedVisitDate}" th:text="${patientvisit.formattedVisitDate}">01/01/2025</span>
                                <span th:unless="${patientvisit.formattedVisitDate}" th:text="${patientvisit.visitdate}">2025-01-01</span>
                            </td>
                            <td>
                                <div th:if="${patientvisit.patientName}" class="patient-info">
                                    <span th:text="${patientvisit.patientName}">John Doe (jdoe)</span>
                                    <small th:if="${patientvisit.patientAge}" class="text-muted d-block">
                                        Age: [[${patientvisit.patientAge}]] years
                                    </small>
                                </div>
                                <span th:unless="${patientvisit.patientName}">[[${patientvisit.patient}]]</span>
                            </td>
                            <td>
                                <div th:if="${patientvisit.doctorName}" class="doctor-info">
                                    <span th:text="${patientvisit.doctorName}">Dr. John Smith</span>
                                </div>
                                <span th:unless="${patientvisit.doctorName}">[[${patientvisit.doctor}]]</span>
                            </td>
                            <td>
                                <!-- Secretary cannot see diagnosis -->
                                <div th:if="${isSecretary}" class="no-access">
                                    <i class="bi bi-lock-fill"></i> [No Access - Medical Data]
                                </div>
                                
                                <!-- Doctors and Admin can see diagnosis -->
                                <div th:unless="${isSecretary}">
                                    <span th:if="${patientvisit.diagnosis == '[Encrypted]'}" class="text-muted">
                                        <i class="bi bi-lock"></i> [Encrypted - Old Data]
                                    </span>
                                    <span th:if="${patientvisit.diagnosis != null and patientvisit.diagnosis != '[Encrypted]'}" 
                                          th:text="${patientvisit.diagnosis}">Diagnosis text</span>
                                    <span th:if="${patientvisit.diagnosis == null}" class="text-muted">No diagnosis</span>
                                    <span th:if="${patientvisit.diagnosis != null}" class="badge bg-info diagnosis-badge ms-1">
                                        <i class="bi bi-shield-lock"></i> Encrypted
                                    </span>
                                </div>
                            </td>
                            <td>
                                <div class="float-end text-nowrap">
                                    <!-- Admin can edit/delete all -->
                                    <div th:if="${isAdmin}">
                                        <a th:href="@{/patientvisits/edit/{visitid}(visitid=${patientvisit.visitid})}" 
                                           class="btn btn-sm btn-secondary">Edit</a>
                                        <form th:action="@{/patientvisits/delete/{visitid}(visitid=${patientvisit.visitid})}"
                                                data-confirm-message="Are you sure you want to delete this exam?" 
                                                method="post" class="js-submit-confirm d-inline">
                                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                        </form>
                                    </div>
                                    
                                    <!-- Doctor can only edit/delete their own visits -->
                                    <div th:if="${isDoctor and !isAdmin}">
                                        <!-- Check if this visit belongs to current doctor -->
                                        <div th:if="${patientvisit.doctorUsername == currentUsername}">
                                            <a th:href="@{/patientvisits/edit/{visitid}(visitid=${patientvisit.visitid})}" 
                                               class="btn btn-sm btn-secondary">Edit</a>
                                            <form th:action="@{/patientvisits/delete/{visitid}(visitid=${patientvisit.visitid})}"
                                                    data-confirm-message="Are you sure you want to delete this exam?" 
                                                    method="post" class="js-submit-confirm d-inline">
                                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                            </form>
                                        </div>
                                        <div th:unless="${patientvisit.doctorUsername == currentUsername}">
                                            <span class="text-muted small">View only</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Secretary has no edit/delete rights -->
                                    <div th:unless="${isDoctor or isAdmin}">
                                        <span class="text-muted small">View only</span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </body>
</html>