<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        layout:decorate="~{layout}">
    <head>
        <meta charset="UTF-8">
        <title>Audit Logs - Real Time</title>
        <style>
            .audit-table {
                font-size: 0.9em;
            }
            .success-true {
                background-color: rgba(40, 167, 69, 0.1);
            }
            .success-false {
                background-color: rgba(220, 53, 69, 0.1);
            }
            .event-AUTHENTICATION {
                color: #0066cc;
                font-weight: bold;
            }
            .event-DATA_ACCESS {
                color: #28a745;
            }
            .event-SECURITY_VIOLATION {
                color: #dc3545;
                font-weight: bold;
            }
            .event-ADMIN_ACTION {
                color: #6f42c1;
                font-weight: bold;
            }
            .event-PASSWORD_CHANGE {
                color: #fd7e14;
            }
            .auto-refresh-indicator {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }
            .new-row {
                animation: slideIn 0.5s ease-out;
            }
            @keyframes slideIn {
                from { 
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to { 
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>
    </head>
    <body>
        <div layout:fragment="content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>
                    <i class="fas fa-shield-alt"></i> Security Audit Logs
                    <span id="refreshIndicator" class="badge bg-success auto-refresh-indicator" style="font-size: 0.5em;">
                        <i class="fas fa-sync"></i> LIVE
                    </span>
                </h1>
                <div>
                    <button class="btn btn-primary" onclick="refreshLogs()">
                        <i class="fas fa-sync-alt"></i> Manual Refresh
                    </button>
                    <label class="ms-3">
                        <input type="checkbox" id="autoRefresh" checked> Auto-refresh (5s)
                    </label>
                </div>
            </div>
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> 
                Showing last 100 audit events. Auto-refreshes every 5 seconds.
                <span class="float-end">Last update: <span id="lastUpdate"></span></span>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped table-hover audit-table">
                    <thead class="table-dark">
                        <tr>
                            <th>Timestamp</th>
                            <th>User</th>
                            <th>Event Type</th>
                            <th>Description</th>
                            <th>Entity</th>
                            <th>Success</th>
                            <th>IP Address</th>
                        </tr>
                    </thead>
                    <tbody id="auditLogsBody">
                        <tr th:each="log : ${auditLogs}" 
                            th:class="${log.success ? 'success-true' : 'success-false'}"
                            th:data-id="${log.id}">
                            <td th:text="${log.formattedTimestamp}"></td>
                            <td>
                                <strong th:text="${log.username}"></strong>
                            </td>
                            <td>
                                <span th:class="'event-' + ${log.event_type}" th:text="${log.event_type}"></span>
                            </td>
                            <td th:text="${log.event_description}"></td>
                            <td>
                                <span th:if="${log.entity_type}">
                                    <span th:text="${log.entity_type}"></span>
                                    <span th:if="${log.entity_id}" class="badge bg-light text-dark" th:text="'#' + ${log.entity_id}"></span>
                                </span>
                                <span th:unless="${log.entity_type}">-</span>
                            </td>
                            <td>
                                <span th:if="${log.success}" class="badge bg-success">Success</span>
                                <span th:unless="${log.success}" class="badge bg-danger">Failed</span>
                            </td>
                            <td>
                                <small th:text="${log.ip_address ?: '-'}"></small>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <script>
                let autoRefreshInterval;
                let lastId = 0;
                
                // Get the highest ID from current logs
                function updateLastId() {
                    const rows = document.querySelectorAll('#auditLogsBody tr');
                    rows.forEach(row => {
                        const id = parseInt(row.dataset.id);
                        if (id > lastId) {
                            lastId = id;
                        }
                    });
                }
                
                function refreshLogs() {
                    fetch('/admin/audit-logs/refresh?limit=100')
                        .then(response => response.json())
                        .then(data => {
                            const tbody = document.getElementById('auditLogsBody');
                            tbody.innerHTML = '';
                            
                            data.forEach(log => {
                                const row = createLogRow(log);
                                tbody.appendChild(row);
                            });
                            
                            updateLastUpdate();
                            updateLastId();
                        })
                        .catch(error => console.error('Error refreshing logs:', error));
                }
                
                function getLiveLogs() {
                    const url = lastId > 0 ? `/admin/audit-logs/live?afterId=${lastId}` : '/admin/audit-logs/live';
                    
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            if (data.length > 0) {
                                const tbody = document.getElementById('auditLogsBody');
                                
                                // Add new logs at the top
                                data.reverse().forEach(log => {
                                    const row = createLogRow(log);
                                    row.classList.add('new-row');
                                    tbody.insertBefore(row, tbody.firstChild);
                                    
                                    // Update lastId
                                    if (log.id > lastId) {
                                        lastId = log.id;
                                    }
                                });
                                
                                // Remove old logs if more than 100
                                while (tbody.children.length > 100) {
                                    tbody.removeChild(tbody.lastChild);
                                }
                                
                                updateLastUpdate();
                            }
                        })
                        .catch(error => console.error('Error getting live logs:', error));
                }
                
                function createLogRow(log) {
                    const row = document.createElement('tr');
                    row.className = log.success ? 'success-true' : 'success-false';
                    row.dataset.id = log.id;
                    
                    row.innerHTML = `
                        <td>${log.formattedTimestamp || ''}</td>
                        <td><strong>${log.username || ''}</strong></td>
                        <td><span class="event-${log.event_type}">${log.event_type || ''}</span></td>
                        <td>${log.event_description || ''}</td>
                        <td>${log.entity_type ? `${log.entity_type}${log.entity_id ? ' <span class="badge bg-light text-dark">#' + log.entity_id + '</span>' : ''}` : '-'}</td>
                        <td>${log.success ? '<span class="badge bg-success">Success</span>' : '<span class="badge bg-danger">Failed</span>'}</td>
                        <td><small>${log.ip_address || '-'}</small></td>
                    `;
                    
                    return row;
                }
                
                function updateLastUpdate() {
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                }
                
                function toggleAutoRefresh() {
                    if (document.getElementById('autoRefresh').checked) {
                        autoRefreshInterval = setInterval(getLiveLogs, 5000);
                        document.getElementById('refreshIndicator').style.display = 'inline-block';
                    } else {
                        clearInterval(autoRefreshInterval);
                        document.getElementById('refreshIndicator').style.display = 'none';
                    }
                }
                
                // Initialize
                document.addEventListener('DOMContentLoaded', function() {
                    updateLastUpdate();
                    updateLastId();
                    
                    // Set up auto-refresh
                    document.getElementById('autoRefresh').addEventListener('change', toggleAutoRefresh);
                    toggleAutoRefresh();
                });
            </script>
        </div>
    </body>
</html>
