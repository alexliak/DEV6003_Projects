<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Password History Management</title>
    <style>
        .admin-header {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 20px;
            margin-bottom: 30px;
        }
        .admin-header h2 {
            margin: 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        .admin-header i {
            font-size: 2rem;
        }
        .data-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 30px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table thead {
            background: #f8f9fa;
        }
        .data-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
        }
        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        .data-table tr:hover {
            background: #f8f9fa;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .status-expired {
            background: #fee;
            color: #dc3545;
        }
        .status-expiring {
            background: #fff3cd;
            color: #856404;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        .hash-display {
            font-family: monospace;
            font-size: 0.75rem;
            color: #6c757d;
            word-break: break-all;
            max-width: 200px;
            display: inline-block;
            vertical-align: top;
        }
        .hash-item {
            background: #f8f9fa;
            padding: 4px 8px;
            margin: 2px 0;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }
        .force-change-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .force-change-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
        .force-change-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .pagination a {
            padding: 8px 16px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            text-decoration: none;
            color: #495057;
            transition: all 0.3s ease;
        }
        .pagination a:hover {
            background: #f8f9fa;
            border-color: #667eea;
            color: #667eea;
        }
        .pagination .active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .info-box {
            background: #e7f3ff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #0066cc;
        }
        .info-box h5 {
            color: #0066cc;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .info-box p {
            margin: 0;
            color: #495057;
        }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div class="admin-header">
            <h2>
                <i class="fas fa-key"></i> Password History Management
            </h2>
        </div>
        
        <!-- Info Box -->
        <div class="info-box">
            <h5><i class="fas fa-info-circle"></i> Password Policy Information</h5>
            <p>• Passwords expire after 90 days</p>
            <p>• Users cannot reuse their last 5 passwords</p>
            <p>• Only password hashes are stored - actual passwords are never visible</p>
            <p>• Force password change will require user to change password on next login</p>
        </div>
        
        <!-- Error/Success Messages -->
        <div th:if="${MSG_SUCCESS}" class="alert alert-success" role="alert">
            <i class="fas fa-check-circle"></i> <span th:text="${MSG_SUCCESS}"></span>
        </div>
        <div th:if="${MSG_ERROR}" class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-circle"></i> <span th:text="${MSG_ERROR}"></span>
        </div>
        
        <!-- User Password Data Table -->
        <div class="data-card">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Last Changed</th>
                        <th>Status</th>
                        <th>History Count</th>
                        <th>Password Hashes</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="user : ${users}">
                        <td>
                            <strong th:text="${user.username}">username</strong>
                        </td>
                        <td th:text="${user.email}">email@example.com</td>
                        <td>
                            <span th:if="${user.lastPasswordChange != null}">
                                <span th:text="${#dates.format(user.lastPasswordChange, 'dd/MM/yyyy')}">01/01/2025</span>
                                <br>
                                <small class="text-muted" th:text="${'(' + user.daysSinceChange + ' days ago)'}"></small>
                            </span>
                            <span th:if="${user.lastPasswordChange == null}" class="text-muted">Never</span>
                        </td>
                        <td>
                            <span th:if="${user.forcePasswordChange}" class="status-badge status-expired">
                                Force Change
                            </span>
                            <span th:if="${!user.forcePasswordChange and user.passwordExpired}" class="status-badge status-expired">
                                Expired
                            </span>
                            <span th:if="${!user.forcePasswordChange and !user.passwordExpired and user.daysSinceChange != null and user.daysSinceChange > 80}" 
                                  class="status-badge status-expiring">
                                Expiring Soon
                            </span>
                            <span th:if="${!user.forcePasswordChange and !user.passwordExpired and (user.daysSinceChange == null or user.daysSinceChange <= 80)}" 
                                  class="status-badge status-active">
                                Active
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-secondary" th:text="${user.passwordHistoryCount}">0</span>
                        </td>
                        <td>
                            <div class="hash-display" th:if="${user.passwordHistoryCount > 0}">
                                <div th:each="hash, iter : ${user.passwordHashes}" 
                                     th:if="${iter.index < 2}" 
                                     class="hash-item">
                                    <small th:text="${'Hash ' + (iter.index + 1) + ': ' + #strings.substring(hash, 0, 20) + '...'}">
                                        Hash 1: $2a$12$...
                                    </small>
                                </div>
                                <small th:if="${user.passwordHistoryCount > 2}" class="text-muted">
                                    ... and <span th:text="${user.passwordHistoryCount - 2}">3</span> more
                                </small>
                            </div>
                            <span th:if="${user.passwordHistoryCount == 0}" class="text-muted">No history</span>
                        </td>
                        <td>
                            <form th:action="@{/admin/users/{id}/force-password-change(id=${user.id})}" 
                                  method="post" 
                                  style="display: inline;">
                                <button type="submit" 
                                        class="force-change-btn"
                                        th:disabled="${user.forcePasswordChange}"
                                        th:text="${user.forcePasswordChange ? 'Already Set' : 'Force Change'}">
                                    Force Change
                                </button>
                            </form>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="pagination" th:if="${totalPages > 1}">
            <a th:href="@{/admin/users/password-history(page=${currentPage - 1})}" 
               th:if="${currentPage > 0}">Previous</a>
            
            <span th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                <a th:href="@{/admin/users/password-history(page=${i})}" 
                   th:text="${i + 1}"
                   th:class="${i == currentPage ? 'active' : ''}">1</a>
            </span>
            
            <a th:href="@{/admin/users/password-history(page=${currentPage + 1})}" 
               th:if="${currentPage < totalPages - 1}">Next</a>
        </div>
        
        <div class="text-center mt-4">
            <p class="text-muted">
                Showing page <strong th:text="${currentPage + 1}">1</strong> of 
                <strong th:text="${totalPages}">1</strong>
                (Total users: <strong th:text="${totalUsers}">0</strong>)
            </p>
        </div>
    </div>
</body>
</html>
